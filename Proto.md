Пару слов о протоколе надо сказать:
Первоначально мы создаем поток с каким-то протоколом, соответствующим скажем так порту, т.е. базовый протокол экселлента, в котором будут реализован 2 команды: auth1 и reg
Далее шлется команда рег или аут и тогда тебе сообщают новый протокол, на основе твоего MDI, а также говорят, что отправить следует, но в том и юмор, что отправить просто так нельзя, а только через очередь отправки
Короче надо реально сделать команды, которые не записывать в историю без аппрува. А апрув либо получать по подтверждению, либо таймаут ожидания уничтожает команду и все команды временного буфера